<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Login - Improved (Working Version)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #fileInput {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-preview {
            max-width: 300px;
            max-height: 300px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #e9ecef;
        }
        .working-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .saved-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .saved-image-item {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .saved-image-item:hover {
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        }
        .saved-image-item.selected {
            border-color: #28a745;
            background-color: #e8f5e8;
        }
        .saved-image-item img {
            width: 100%;
            max-width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .saved-image-item .image-info {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>    <div class="container">
        <h1>üîê Face Login System - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</h1>
        <p><span class="working-indicator"></span><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ‡πÉ‡∏ä‡πâ endpoint ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ <code>/api/face-analysis/analyze</code></p>
          <div class="test-section" style="background: #d4edda; border-color: #c3e6cb;">
            <h2>‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• admin01</h2>
            <div style="font-size: 14px; line-height: 1.6;">
                <p><strong>üéØ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong></p>
                <ul>
                    <li><strong>üë§ Username:</strong> admin01</li>
                    <li><strong>üîë Password:</strong> admin01</li>
                    <li><strong>üìß Email:</strong> admin@email.com</li>
                    <li><strong>‚úÖ Face Login:</strong> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß)</li>
                </ul>
                
                <p><strong>üöÄ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡πá‡∏ß:</strong></p>
                <ol>
                    <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong>"üë§ ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ Admin ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á"</strong> ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</li>
                    <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong>"üîë ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Face Login ‡∏à‡∏£‡∏¥‡∏á"</strong></li>
                    <li>‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</li>
                </ol>

                <p><strong>üîó ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°:</strong></p>
                <ul>
                    <li><strong>Password Login:</strong> <a href="/login" target="_blank">http://localhost:3000/login</a></li>
                    <li><strong>Face Login:</strong> ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠ <a href="/login" target="_blank">‡∏´‡∏ô‡πâ‡∏≤ login ‡∏´‡∏•‡∏±‡∏Å</a></li>
                </ul>
            </div>
        </div>

        <div class="test-section" style="background: #fff3cd; border-color: #ffeaa7;">
            <h2>üìã ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2><ol style="font-size: 14px; line-height: 1.6;">
                <li><strong>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤:</strong> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="/register" target="_blank">‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a> ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ 15 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏†‡∏≤‡∏û‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</li>
                <li><strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "üë• ‡∏î‡∏π Users ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ users ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                <li><strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Face Gallery:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "üîó ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Face-User Mapping" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</li>
                <li><strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "üìÅ ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û cropped ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</li>
                <li><strong>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà:</strong> ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</li>
                <li><strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Face Recognition:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "üîç Test Face Recognition" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏î‡∏à‡∏≥‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</li>
                <li><strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö Login ‡∏à‡∏£‡∏¥‡∏á:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "üîë ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Face Login ‡∏à‡∏£‡∏¥‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á</li>
            </ol>
            <p><strong>‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô "temp" ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ user ‡∏ó‡∏µ‡πà‡∏°‡∏µ ID = "temp" ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            <p><strong>üìÅ ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ‡∏†‡∏≤‡∏û cropped faces ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà <code>registration-faces/current-registration/</code></p>
        </div>
        
        <div class="test-section">
            <h2>üéØ Face Recognition Test</h2>
            <p>Upload an image to test face recognition using the verified working endpoint.</p>
            
            <input type="file" id="fileInput" accept="image/*">
            <img id="imagePreview" class="image-preview" style="display: none;">
            
            <div>
                <button onclick="testFaceRecognition()" id="testBtn">üîç Test Face Recognition</button>
                <button onclick="testDirectAPI()" id="apiBtn">üîß Test Direct API</button>
                <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
            </div>
            
            <div id="recognitionResult"></div>
        </div>        <div class="test-section">
            <h2>üîê Test Face Login with Database</h2>
            <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏±‡∏ö Database</p>
            
            <input type="file" id="loginFileInput" accept="image/*">
            <img id="loginImagePreview" class="image-preview" style="display: none;">            <div>
                <button onclick="testRealFaceLogin()" id="realLoginBtn">üîë ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Face Login ‡∏à‡∏£‡∏¥‡∏á</button>
                <button onclick="loadAdminSample()" id="adminSampleBtn" style="background-color: #28a745; color: white;">üë§ ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ Admin ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
                <button onclick="checkDatabaseUsers()">üë• ‡∏î‡∏π Users ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button onclick="checkFaceGalleryMapping()">üîó ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Face-User Mapping</button>
                <button onclick="loadSavedFaceImages()">üìÅ ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</button>
            </div>
              <div id="realLoginResult"></div>
        </div>

        <div class="test-section" id="savedImagesSection" style="display: none;">
            <h2>üìÅ ‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà crop ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
            <div id="savedImagesList" class="saved-images-grid"></div>
            <div>
                <button onclick="testSelectedImage()" id="testSelectedBtn" style="display: none;">üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                <button onclick="hideSavedImages()">‚ùå ‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>

        <div class="test-section">
            <h2>üìä System Status</h2>
            <button onclick="checkGalleryStatus()">üë• Check Gallery</button>
            <button onclick="checkAPIHealth()">üè• Check API Health</button>
            <div id="statusResult"></div>
        </div>

        <div class="test-section">
            <h2>üìã Technical Details</h2>
            <div id="technicalDetails">
                <p><strong>Working Configuration:</strong></p>
                <ul>
                    <li><strong>Endpoint:</strong> <code>POST /api/face-analysis/analyze</code></li>
                    <li><strong>Method:</strong> File upload (multipart/form-data)</li>
                    <li><strong>Mode:</strong> full_analysis</li>
                    <li><strong>Model:</strong> YOLOv9c + FaceNet</li>
                    <li><strong>Success Rate:</strong> 100% detection, 63.9% recognition confidence</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let currentAnalysis = null;        // Preview uploaded image for login test
        document.getElementById('loginFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('loginImagePreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Test real face login with database
        async function testRealFaceLogin() {
            const fileInput = document.getElementById('loginFileInput');
            const resultDiv = document.getElementById('realLoginResult');
            const loginBtn = document.getElementById('realLoginBtn');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô!</div>';
                return;
            }

            try {
                loginBtn.disabled = true;
                loginBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
                resultDiv.innerHTML = '<div class="info">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö Face Login ‡∏Å‡∏±‡∏ö Database...</div>';
                
                const file = fileInput.files[0];
                
                // Convert to base64
                const base64Image = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const startTime = Date.now();
                
                // Call the real login API
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        faceImageBase64: base64Image,
                        loginMethod: 'face'
                    })
                });

                const processingTime = Date.now() - startTime;
                const result = await response.json();

                if (result.success) {
                    displayLoginSuccess(result, processingTime);
                } else {
                    displayLoginFailure(result, processingTime, response.status);
                }

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4>
                        <p>${error.message}</p>
                        <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Next.js server ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà port 3000</p>
                    </div>
                `;
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'üîë ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Face Login ‡∏à‡∏£‡∏¥‡∏á';
            }        }

        // Load admin sample image
        async function loadAdminSample() {
            try {
                const response = await fetch('/admin_face_sample.jpg');
                if (!response.ok) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ');
                }
                
                const blob = await response.blob();
                const file = new File([blob], 'admin_face_sample.jpg', { type: 'image/jpeg' });
                
                // Update file input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                const fileInput = document.getElementById('loginFileInput');
                fileInput.files = dataTransfer.files;
                
                // Show preview
                const loginImagePreview = document.getElementById('loginImagePreview');
                loginImagePreview.src = URL.createObjectURL(file);
                loginImagePreview.style.display = 'block';
                
                // Update result
                const resultDiv = document.getElementById('realLoginResult');
                resultDiv.innerHTML = '<div class="info">‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á admin01 ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "üîë ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Face Login ‡∏à‡∏£‡∏¥‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>';
                
            } catch (error) {
                const resultDiv = document.getElementById('realLoginResult');
                resultDiv.innerHTML = `<div class="error">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ: ${error.message}</div>`;
            }
        }

        function displayLoginSuccess(result, processingTime) {
            const resultDiv = document.getElementById('realLoginResult');
            const userData = result.data.user;
            
            resultDiv.innerHTML = `
                <div class="success">
                    <h4>üéâ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h4>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value">${processingTime}ms</div>
                            <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${result.data.confidencePercentage || 'N/A'}</div>
                            <div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${result.data.loginMethod}</div>
                            <div class="stat-label">‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
                        </div>
                    </div>
                    
                    <h5>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡∏ó‡∏ä‡πå:</h5>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 10px 0;">
                        <strong>üÜî User ID:</strong> ${userData.id}<br>
                        <strong>üìß Email:</strong> ${userData.email}<br>
                        <strong>üë§ Username:</strong> ${userData.username}<br>
                        <strong>üè∑Ô∏è ‡∏ä‡∏∑‡πà‡∏≠:</strong> ${userData.fullName}<br>
                        <strong>üìÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${new Date(userData.createdAt).toLocaleDateString('th-TH')}<br>
                        <strong>üïê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${userData.lastLoginAt ? new Date(userData.lastLoginAt).toLocaleString('th-TH') : '‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å'}<br>
                        <strong>‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${userData.isActive ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' : '‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
                    </div>
                    
                    <h5>üîê Session Information:</h5>
                    <ul>
                        <li><strong>Token:</strong> ${result.data.token.substring(0, 30)}...</li>
                        <li><strong>Message:</strong> ${result.message}</li>
                    </ul>
                </div>
            `;
        }

        function displayLoginFailure(result, processingTime, statusCode) {
            const resultDiv = document.getElementById('realLoginResult');
            
            let errorType = '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
            let recommendations = [];
            
            if (statusCode === 400) {
                errorType = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                recommendations.push('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤');
                recommendations.push('‡∏•‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏™‡∏á‡∏î‡∏µ');
            } else if (statusCode === 401) {
                errorType = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';
                recommendations.push('‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                recommendations.push('‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
            } else if (statusCode === 404) {
                errorType = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                recommendations.push('User ‡∏ó‡∏µ‡πà‡∏à‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            } else if (statusCode === 500) {
                errorType = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå';
                recommendations.push('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Face Recognition API ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô');
                recommendations.push('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö log ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
            }
            
            resultDiv.innerHTML = `
                <div class="error">
                    <h4>‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h4>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value">${processingTime}ms</div>
                            <div class="stat-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${statusCode}</div>
                            <div class="stat-label">Status Code</div>
                        </div>
                    </div>
                    
                    <p><strong>üö® ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:</strong> ${errorType}</p>
                    <p><strong>üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</strong> ${result.message}</p>
                    
                    <h5>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</h5>
                    <ul>
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;
        }        // Check database users
        async function checkDatabaseUsers() {
            const resultDiv = document.getElementById('realLoginResult');
            resultDiv.innerHTML = '<div class="info">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Users ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>';

            try {
                const response = await fetch('/api/users/list');
                const result = await response.json();

                if (result.success) {
                    const users = result.data.users;
                    const stats = result.data.statistics;
                    
                    let html = `
                        <div class="success">
                            <h4>ÔøΩ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
                            
                            <div class="stats">
                                <div class="stat-box">
                                    <div class="stat-value">${stats.totalUsers}</div>
                                    <div class="stat-label">Users ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">${stats.activeUsers}</div>
                                    <div class="stat-label">Users ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">${stats.usersWithFaceEmbeddings}</div>
                                    <div class="stat-label">‡∏°‡∏µ Face Data</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">${stats.recentLogins}</div>
                                    <div class="stat-label">Login ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (7 ‡∏ß‡∏±‡∏ô)</div>
                                </div>
                            </div>
                            
                            <h5>üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Users:</h5>
                            <div style="max-height: 400px; overflow-y: auto;">
                    `;
                    
                    if (users.length > 0) {
                        users.forEach((user, index) => {
                            const statusColor = user.isActive ? '#28a745' : '#dc3545';
                            const faceIcon = user.hasFaceEmbeddings ? 'üë§' : '‚ùå';
                            html += `
                                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 10px; margin: 5px 0;">
                                    <strong>${index + 1}. ${user.fullName}</strong>
                                    <br>
                                    <small>
                                        <strong>ID:</strong> ${user.id} | 
                                        <strong>Email:</strong> ${user.email} | 
                                        <strong>Username:</strong> ${user.username}
                                        <br>
                                        <span style="color: ${statusColor};">
                                            <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${user.isActive ? '‚úÖ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ' : '‚ùå ‡∏£‡∏∞‡∏á‡∏±‡∏ö'}
                                        </span> |
                                        <strong>Face Data:</strong> ${faceIcon} ${user.hasFaceEmbeddings ? `(${user.faceEmbeddingCount} embeddings)` : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}
                                        <br>
                                        <strong>‡∏™‡∏£‡πâ‡∏≤‡∏á:</strong> ${new Date(user.createdAt).toLocaleDateString('th-TH')} |
                                        <strong>Login ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</strong> ${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString('th-TH') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢'}
                                    </small>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ Users ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                    }
                    
                    html += `
                            </div>
                            
                            <h5>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</h5>
                            <ul>
                                <li>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ Face Data ‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ</li>
                                <li>‡∏´‡∏≤‡∏Å Face Recognition API ‡∏à‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô "temp" ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤ user ‡∏ó‡∏µ‡πà‡∏°‡∏µ ID ‡∏´‡∏£‡∏∑‡∏≠ username = "temp"</li>
                                <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ user ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ"</li>
                            </ul>
                        </div>
                    `;
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users ‡πÑ‡∏î‡πâ</h4>
                            <p>${result.message}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</h4>
                        <p>${error.message}</p>
                        <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Next.js server ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà port 3000</p>
                    </div>
                `;
            }
        }

        // Preview uploaded image
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('imagePreview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Test face recognition using working endpoint
        async function testFaceRecognition() {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('recognitionResult');
            const testBtn = document.getElementById('testBtn');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">‚ùå Please select an image first!</div>';
                return;
            }

            try {
                testBtn.disabled = true;
                testBtn.textContent = 'üîÑ Processing...';
                resultDiv.innerHTML = '<div class="info">üîÑ Analyzing face using working endpoint...</div>';
                
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('mode', 'full_analysis');

                const startTime = Date.now();
                const response = await fetch('http://localhost:8080/api/face-analysis/analyze', {
                    method: 'POST',
                    body: formData
                });

                const processingTime = Date.now() - startTime;
                const result = await response.json();
                currentAnalysis = result;

                if (response.ok && result.success && result.faces && result.faces.length > 0) {
                    displaySuccessfulRecognition(result, processingTime);
                } else if (response.ok && result.success) {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå No Faces Detected</h4>
                            <p>The image was processed successfully but no faces were found.</p>
                            <p><strong>Processing Time:</strong> ${processingTime}ms</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå API Error</h4>
                            <p><strong>Status:</strong> ${response.status}</p>
                            <p><strong>Message:</strong> ${result.message || 'Unknown error'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Network Error</h4>
                        <p>${error.message}</p>
                        <p>Make sure the Face Recognition API is running on localhost:8080</p>
                    </div>
                `;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'üîç Test Face Recognition';
            }
        }

        function displaySuccessfulRecognition(result, processingTime) {
            const resultDiv = document.getElementById('recognitionResult');
            const face = result.faces[0];
            
            let html = `
                <div class="success">
                    <h4>‚úÖ Face Recognition Successful!</h4>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-value">${result.faces.length}</div>
                            <div class="stat-label">Faces Detected</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${(face.detection_confidence * 100).toFixed(1)}%</div>
                            <div class="stat-label">Detection Confidence</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${processingTime}ms</div>
                            <div class="stat-label">Processing Time</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${face.quality_score}%</div>
                            <div class="stat-label">Face Quality</div>
                        </div>
                    </div>
                    
                    <h5>üéØ Recognition Results:</h5>
            `;

            if (face.has_identity && face.matches && face.matches.length > 0) {
                html += `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; margin: 10px 0;">
                        <strong>‚úÖ Identity Found:</strong> ${face.identity}<br>
                        <strong>üîç Recognition Confidence:</strong> ${(face.recognition_confidence * 100).toFixed(1)}%<br>
                        <strong>üèÜ Best Match:</strong> ${face.best_match.person_name} (${(face.best_match.confidence * 100).toFixed(1)}%)<br>
                        <strong>üìä Match Quality:</strong> ${face.best_match.match_quality}<br>
                        <strong>üî¨ Comparison Method:</strong> ${face.best_match.comparison_method}
                    </div>
                `;
                
                if (face.matches.length > 1) {
                    html += '<h6>üîç All Matches:</h6><ul>';
                    face.matches.forEach((match, i) => {
                        html += `<li>${match.person_name}: ${(match.confidence * 100).toFixed(1)}% confidence</li>`;
                    });
                    html += '</ul>';
                }
            } else {
                html += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin: 10px 0;">
                        <strong>‚ö†Ô∏è No Identity Match:</strong> Face detected but no matching identity found in the gallery.
                    </div>
                `;
            }

            html += `
                    <h5>üìà Performance Metrics:</h5>
                    <ul>
                        <li><strong>Detection Time:</strong> ${(result.performance.detection_time * 1000).toFixed(1)}ms</li>
                        <li><strong>Recognition Time:</strong> ${(result.performance.recognition_time * 1000).toFixed(1)}ms</li>
                        <li><strong>Total Processing:</strong> ${(result.performance.total_time * 1000).toFixed(1)}ms</li>
                        <li><strong>Faces/Second:</strong> ${result.performance.faces_per_second.toFixed(1)}</li>
                    </ul>
                    
                    <h5>ü§ñ Models Used:</h5>
                    <ul>
                        <li><strong>Detection:</strong> ${result.models_used.detection_model}</li>
                        <li><strong>Recognition:</strong> ${result.models_used.recognition_model}</li>
                    </ul>
                </div>
            `;

            resultDiv.innerHTML = html;
        }

        // Test direct API call with raw response
        async function testDirectAPI() {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('recognitionResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">‚ùå Please select an image first!</div>';
                return;
            }

            try {
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('mode', 'full_analysis');

                const response = await fetch('http://localhost:8080/api/face-analysis/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="info">
                        <h4>üîß Raw API Response</h4>
                        <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                        <p><strong>Content-Type:</strong> ${response.headers.get('content-type')}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå API Test Failed</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Check gallery status
        async function checkGalleryStatus() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.innerHTML = '<div class="info">üîÑ Checking gallery...</div>';

            try {
                const response = await fetch('http://localhost:8080/api/face-recognition/gallery/get');
                const result = await response.json();

                if (response.ok && result.gallery) {
                    const personCount = Object.keys(result.gallery).length;
                    let html = `
                        <div class="success">
                            <h4>‚úÖ Gallery Status</h4>
                            <p><strong>Registered Persons:</strong> ${personCount}</p>
                    `;

                    if (personCount > 0) {
                        html += '<h5>üë• Registered Identities:</h5><ul>';
                        Object.entries(result.gallery).forEach(([personId, data]) => {
                            const embeddingCount = data.embeddings ? data.embeddings.length : 0;
                            html += `<li><strong>${personId}:</strong> ${embeddingCount} embeddings</li>`;
                        });
                        html += '</ul>';
                    }

                    html += '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Gallery Error</h4>
                            <p>Status: ${response.status}</p>
                            <p>Could not retrieve gallery information</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Gallery Check Failed</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Check API health
        async function checkAPIHealth() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.innerHTML = '<div class="info">üîÑ Checking API health...</div>';

            try {
                const response = await fetch('http://localhost:8080/health');
                const result = await response.json();

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ API Health Check</h4>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Health Check Failed</h4>
                        <p>${error.message}</p>
                        <p>Make sure the API is running on http://localhost:8080</p>
                    </div>
                `;
            }
        }

        // Clear results
        function clearResults() {
            document.getElementById('recognitionResult').innerHTML = '';
            document.getElementById('statusResult').innerHTML = '';
            currentAnalysis = null;        }

        // Check face gallery mapping
        async function checkFaceGalleryMapping() {
            const resultDiv = document.getElementById('realLoginResult');
            resultDiv.innerHTML = '<div class="info">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Face Gallery ‡πÅ‡∏•‡∏∞ Database...</div>';

            try {
                // Get gallery data
                const galleryResponse = await fetch('http://localhost:8080/api/face-recognition/gallery/get');
                const galleryData = await galleryResponse.json();

                // Get database users
                const usersResponse = await fetch('/api/users/list');
                const usersData = await usersResponse.json();

                if (galleryData.gallery && usersData.success) {
                    const gallery = galleryData.gallery;
                    const users = usersData.data.users;
                    
                    let html = `
                        <div class="info">
                            <h4>üîó Face Gallery ‡πÅ‡∏•‡∏∞ Database Mapping</h4>
                            
                            <h5>üé≠ Face Gallery (‡∏à‡∏≤‡∏Å Face Recognition API):</h5>
                            <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin: 10px 0;">
                    `;
                    
                    const galleryPersons = Object.keys(gallery);
                    if (galleryPersons.length > 0) {
                        galleryPersons.forEach(personId => {
                            const embeddings = gallery[personId].embeddings || [];
                            html += `
                                <div style="margin: 5px 0; padding: 8px; background: white; border-radius: 4px;">
                                    <strong>Person ID:</strong> ${personId}<br>
                                    <strong>Embeddings:</strong> ${embeddings.length} vectors
                                </div>
                            `;
                        });
                    } else {
                        html += '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Face Gallery</p>';
                    }
                    
                    html += `
                            </div>
                            
                            <h5>üë• Database Users (‡∏à‡∏≤‡∏Å PostgreSQL):</h5>
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 6px; margin: 10px 0;">
                    `;
                    
                    if (users.length > 0) {
                        users.forEach(user => {
                            const matchIcon = galleryPersons.includes(user.id) ? '‚úÖ' : '‚ùå';
                            html += `
                                <div style="margin: 5px 0; padding: 8px; background: white; border-radius: 4px;">
                                    ${matchIcon} <strong>${user.fullName}</strong> (${user.id})<br>
                                    <small>Face Embeddings: ${user.faceEmbeddingCount}, Active: ${user.isActive ? 'Yes' : 'No'}</small>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ Users ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                    }
                    
                    html += `
                            </div>
                            
                            <h5>üîç ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</h5>
                            <ul>
                    `;
                    
                    // Analysis
                    const matchedUsers = users.filter(u => galleryPersons.includes(u.id));
                    const unmatchedGallery = galleryPersons.filter(p => !users.some(u => u.id === p));
                    const unmatchedUsers = users.filter(u => !galleryPersons.includes(u.id));
                    
                    html += `
                                <li><strong>Users ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô Gallery ‡πÅ‡∏•‡∏∞ Database:</strong> ${matchedUsers.length} ‡∏Ñ‡∏ô</li>
                                <li><strong>Face Gallery ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ User ‡πÉ‡∏ô Database:</strong> ${unmatchedGallery.length} entries</li>
                                <li><strong>Database Users ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Face Gallery:</strong> ${unmatchedUsers.length} ‡∏Ñ‡∏ô</li>
                            </ul>
                            
                            <h5>üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</h5>
                            <ul>
                                <li>‡∏´‡∏≤‡∏Å Face Recognition ‡∏û‡∏ö "${galleryPersons[0] || 'temp'}" ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ User ID ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Database ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</li>
                                <li>‡∏´‡∏≤‡∏Å User ‡πÉ‡∏ô Database ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô Face Gallery ‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</li>
                                <li>‡∏´‡∏≤‡∏Å Gallery ‡∏°‡∏µ ID ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Database ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                            </ul>
                        </div>
                    `;
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</h4>
                            <p>Gallery Success: ${!!galleryData.gallery}</p>
                            <p>Users Success: ${usersData.success}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }        }

        let selectedSavedImage = null;

        // Load saved face images from registration
        async function loadSavedFaceImages() {
            const savedImagesSection = document.getElementById('savedImagesSection');
            const savedImagesList = document.getElementById('savedImagesList');
            
            savedImagesList.innerHTML = '<div class="info">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ...</div>';
            savedImagesSection.style.display = 'block';

            try {
                // Check if registration-faces directory exists and list files
                const response = await fetch('/api/list-saved-faces');
                
                if (response.ok) {
                    const result = await response.json();
                    displaySavedImages(result.images || []);
                } else {
                    // If API doesn't exist, show manual instructions
                    savedImagesList.innerHTML = `
                        <div class="info">
                            <h4>üìÅ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h4>
                            <p>‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà crop ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà:</p>
                            <code>registration-faces/current-registration/</code>
                            
                            <h5>üìã ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</h5>
                            <ol>
                                <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå <code>registration-faces/</code> ‡πÉ‡∏ô root directory</li>
                                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û <code>face-crop-XX-YYYY.jpg</code> ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</li>
                                <li>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ" ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</li>
                                <li>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏° "üîë ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Face Login ‡∏à‡∏£‡∏¥‡∏á"</li>
                            </ol>
                            
                            <p><strong>üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</strong> ‡∏´‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡∏°‡∏µ‡∏†‡∏≤‡∏û 15 ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</p>
                        </div>
                    `;
                }
            } catch (error) {
                savedImagesList.innerHTML = `
                    <div class="error">
                        <h4>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</h4>
                        <p>${error.message}</p>
                        
                        <h5>üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</h5>
                        <ul>
                            <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏†‡∏≤‡∏û‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß</li>
                            <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå <code>registration-faces/</code></li>
                            <li>‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ó‡∏ô</li>
                        </ul>
                    </div>
                `;
            }
        }

        function displaySavedImages(images) {
            const savedImagesList = document.getElementById('savedImagesList');
            
            if (images.length === 0) {
                savedImagesList.innerHTML = `
                    <div class="info">
                        <h4>üìÇ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h4>
                        <p>‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û cropped faces</p>
                        <p>‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="/register" target="_blank">‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a></p>
                    </div>
                `;
                return;
            }

            let html = `<div class="info"><p>‡∏û‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ${images.length} ‡∏†‡∏≤‡∏û - ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</p></div>`;
            
            images.forEach((image, index) => {
                html += `
                    <div class="saved-image-item" onclick="selectSavedImage('${image.path}', ${index})">
                        <img src="${image.path}" alt="Face ${index + 1}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVycm9yPC90ZXh0Pjwvc3ZnPg=='">
                        <div class="image-info">
                            <strong>‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${index + 1}</strong><br>
                            <small>${image.fileName}</small><br>
                            <small>${image.size || 'N/A'}</small>
                        </div>
                    </div>
                `;
            });
            
            savedImagesList.innerHTML = html;
        }

        function selectSavedImage(imagePath, index) {
            // Remove previous selection
            document.querySelectorAll('.saved-image-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            document.querySelectorAll('.saved-image-item')[index].classList.add('selected');
            
            selectedSavedImage = imagePath;
            document.getElementById('testSelectedBtn').style.display = 'inline-block';
            
            console.log('Selected saved image:', imagePath);
        }

        async function testSelectedImage() {
            if (!selectedSavedImage) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const resultDiv = document.getElementById('realLoginResult');
            resultDiv.innerHTML = '<div class="info">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</div>';

            try {
                // Load the selected image and convert to base64
                const response = await fetch(selectedSavedImage);
                const blob = await response.blob();
                
                const base64Image = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(blob);
                });

                // Test with face recognition API first
                await testImageWithFaceAPI(base64Image, '‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ');
                
                // Then test with login API
                await testImageWithLoginAPI(base64Image, '‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ');
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</h4>
                        <p>${error.message}</p>
                        <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°</p>
                    </div>
                `;
            }
        }

        async function testImageWithFaceAPI(base64Image, imageName) {
            const resultDiv = document.getElementById('realLoginResult');
            
            try {
                const imageBuffer = Uint8Array.from(atob(base64Image), c => c.charCodeAt(0));
                const blob = new Blob([imageBuffer], { type: 'image/jpeg' });
                const formData = new FormData();
                formData.append('file', blob, 'test.jpg');
                formData.append('mode', 'full_analysis');

                const response = await fetch('http://localhost:8080/api/face-analysis/analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                let html = `
                    <div class="success">
                        <h4>üîç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ${imageName}</h4>
                        <p><strong>Face API Status:</strong> ${response.status}</p>
                `;
                
                if (result.success && result.faces && result.faces.length > 0) {
                    const face = result.faces[0];
                    html += `
                        <p><strong>‚úÖ ‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤:</strong> ${result.faces.length} ‡∏´‡∏ô‡πâ‡∏≤</p>
                        <p><strong>üéØ ‡∏ï‡∏±‡∏ß‡∏ï‡∏ô:</strong> ${face.identity || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</p>
                        <p><strong>üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à:</strong> ${(face.recognition_confidence * 100).toFixed(1)}%</p>
                        <p><strong>üèÜ ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û:</strong> ${face.quality_score.toFixed(1)}%</p>
                    `;
                } else {
                    html += '<p><strong>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏î‡∏à‡∏≥‡πÑ‡∏î‡πâ</strong></p>';
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Face API test error:', error);
            }
        }

        async function testImageWithLoginAPI(base64Image, imageName) {
            const resultDiv = document.getElementById('realLoginResult');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        faceImageBase64: base64Image,
                        loginMethod: 'face'
                    })
                });

                const result = await response.json();
                
                let html = resultDiv.innerHTML; // Keep previous results
                
                html += `
                    <div class="${result.success ? 'success' : 'error'}">
                        <h4>üîê ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Login ${imageName}</h4>
                        <p><strong>Login API Status:</strong> ${response.status}</p>
                        <p><strong>‡∏ú‡∏•:</strong> ${result.success ? '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'}</p>
                        <p><strong>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</strong> ${result.message}</p>
                `;
                
                if (result.success && result.data) {
                    html += `
                        <p><strong>üë§ User:</strong> ${result.data.user.fullName}</p>
                        <p><strong>üìß Email:</strong> ${result.data.user.email}</p>
                        <p><strong>üÜî ID:</strong> ${result.data.user.id}</p>
                        ${result.data.confidencePercentage ? `<p><strong>üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à:</strong> ${result.data.confidencePercentage}</p>` : ''}
                    `;
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Login API test error:', error);
            }
        }

        function hideSavedImages() {
            document.getElementById('savedImagesSection').style.display = 'none';
            selectedSavedImage = null;
            document.getElementById('testSelectedBtn').style.display = 'none';
        }

        // Auto-check gallery on page load
        window.addEventListener('load', checkGalleryStatus);
    </script>
</body>
</html>
